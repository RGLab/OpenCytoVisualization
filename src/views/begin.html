<!-- vim: ts=2:sw=2:nu:fdc=2:spell -->

<!--<script type='text/javascript'>	LABKEY.requiresExt4ClientAPI(); </script>-->
<script src='//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js'></script>
<script src='//ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js'></script>

<script type='text/javascript'>

    var initOpenCytoVisualization = function(){
        var webPartDiv = <%=webpartContext%>.wrapperDivId;

        var resizeModule;
// REMOVE once issue #18 in OpenCytoVisualization is taken care of

var createTempPnl = function( moduleName ){
    var maskMsg =
        'Seems like you have not enabled the ' + moduleName + ' module, click <a href="' +
        LABKEY.ActionURL.buildURL('admin', 'folderManagement', LABKEY.ActionURL.getContainer(), { tabId: 'folderType' } ) +
        '">here</a> to do so.'

    var temp = new Ext.Panel({
        border: false,
        frame: false,
        height: 100,
        layout: 'fit',
        listeners: {
            afterrender: function(){
                this.getEl().mask( maskMsg, 'infoMask');
            }
        },
        renderTo: webPartDiv
    });

    resizeModule = function(){
        temp.getEl().mask( maskMsg, 'infoMask');
    };

    Ext.EventManager.onWindowResize( resizeModule );
};

LABKEY.Query.getSchemas({
    failure: onFailure,
    success: function(schemasInfo){
        if ( $.inArray( 'opencyto_preprocessing', schemasInfo.schemas ) >= 0 ){
            LABKEY.Query.getQueries({
                failure: onFailure,
                schemaName: 'opencyto_preprocessing',
                success: function(queriesInfo){
                    var i, array = queriesInfo.queries, length = queriesInfo.queries.length;
                    for ( i = 0; i < length; i ++ ){
                        if ( array[i].name == 'StudyVars' ){
                            i = length + 1;
                        }
                    }
                    if ( i != length ){ // i == length + 1 => query present => module present => regular instanciation
// END REMOVE

        var OpenCytoVisualization = new LABKEY.ext.OpenCytoVisualization({
            webPartDivId: webPartDiv
        });

        resizeModule = function(w, h){

            LABKEY.Utils.resizeToViewport( OpenCytoVisualization, w, -1, null, null, -5 );

            OpenCytoVisualization.resize();
        };

        Ext.EventManager.onWindowResize( resizeModule );

// REMOVE once issue #18 in OpenCytoVisualization is taken care of
                    } else {
                        createTempPnl( 'OpenCytoVisualization' );
                    }
                }
            });
        } else {
            createTempPnl( 'OpenCytoPreprocessing' );
        }
    }
});
// END REMOVE

        Ext.EventManager.fireWindowResize();
    }

    Ext.onReady( initOpenCytoVisualization );

</script>
